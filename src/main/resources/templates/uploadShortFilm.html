<!DOCTYPE html>
<html
	data-th-replace="~{@{/fragments/baseLayout} :: layout(~{::title}, ~{::section})}">
<title>Upload a short film - Standby</title>
<section>
	<h3>Upload a short film</h3>
	<hr />
	<div class="row">
		<div class="col-0 col-sm-1"></div>
		<div class="col-12 col-sm-10">
			<form method="POST" enctype="multipart/form-data"
				data-th-action="@{/upload}" data-th-object="${shortFilmUploadData}"
				id="upload-form">
				<div id="general-error-container" class="alert alert-danger d-none" ></div>
				<label class="form-text text-muted">Short film information</label> <input
					data-th-replace="~{@{/fragments/form/input}(name='title', label='Title', placeholder='Godzilla 2', required='true')}" />
				<input
					data-th-replace="~{@{/fragments/form/input}(name='description', label='Description', placeholder='A super awesome description', required='true')}" />

				<input
					data-th-replace="~{@{/fragments/form/file}(name = 'file', label = 'Short Film', buttonLabel = 'Upload', accept = 'video/mp4,video/x-m4v,video/*')}" />
						<div class="progress d-none" id="progress-container">
				<div id="progress-file" class="progress-bar" role="progressbar" style="width: 0%;"
					aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
			</div>
				<br>
				<button type="submit" class="btn btn-success btn-block">Upload
					the film</button>
			</form>
		
			<script>
			
				(() => {const formId = "#upload-form";
				const progressId = "#progress-file";
				
				$(formId).on("submit",function (event) {
					event.preventDefault();
					$.ajax({
						type: "POST",
						url: "/upload",
						enctype: "multipart/form-data",
						data: new FormData($(formId)[0]),
						cache: false,
						contentType: false,
						processData: false,
						xhr: function() {
							const req = $.ajaxSettings.xhr();
							const progress = $(progressId);
							if(req.upload) {
								$("#progress-container").removeClass("d-none");
								req.upload.addEventListener("progress", function(e) {
									if(e.lengthComputable) {							
										const percentage = (e.loaded/e.total*100).toFixed(2);
										progress.text(percentage);
										progress.css("width", percentage+"%");
									}
								});
								
							}
							return req;
						},
						success: function(data) {		
							const status = data.status;
							const message = data.message;
							
							switch(status) {
							case 500:
							
							case 400: {
								const errorContainer = $("#general-error-container");
								errorContainer.removeClass("d-none");
								errorContainer.text(message);
							}break;
							case 302: {
								const url = data.url;
								window.location = "/shortFilm"+url+"/edit"; 

							}break;
							}

						}
						
					})
				})})();
			</script>
		</div>
		<div class="col-0 col-sm-1"></div>
	</div>
</section>
</html>
